name: Publish Twilite

on:
  push:
    tags:
      - "v*"
    branches:
      - "feat/**"
      - "feature/**"

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      - run: npm ci

      # Extract version from package.json once
      - id: version
        run: echo "version=$(jq -r .version package.json)" >> $GITHUB_OUTPUT

      # Decide what we're dealing with
      - name: Set release type
        id: type
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "is_tag=true" >> $GITHUB_OUTPUT
            if [[ "${{ github.ref_name }}" == *-* ]]; then
              echo "prerelease=true" >> $GITHUB_OUTPUT
            else
              echo "prerelease=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "is_tag=false" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
          fi

      # Path creation
      - name: Package extension
        run: mkdir -vp bin

      # Always package
      - name: Package extension
        run: |
          npx vsce package --no-git-tag-version \
            -o bin/twilite-${{ steps.version.outputs.version }}${{ steps.type.outputs.prerelease == 'true' && format('-{0}', github.ref_name) || '' }}.vsix

      # Only publish to Marketplace on real tags
      - name: Publish to VS Code Marketplace
        if: steps.type.outputs.is_tag == 'true'
        run: |
          npx vsce publish \
            ${{ steps.type.outputs.prerelease == 'true' && '--pre-release' || '' }} \
            -i bin/twilite-*.vsix
        env:
          VSCE_PAT: ${{ secrets.VSCE_TOKEN }}
        # We don't always want to publish if we're updating repo just tag
        continue-on-error: true 

      # Always create a GitHub release (pre-release for branches)
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Twilite ${{ github.ref_name }}
          prerelease: ${{ steps.type.outputs.prerelease == 'true' }}
          draft: false
          files: bin/twilite-*.vsix